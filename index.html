<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <script type="module">
      import * as THREE from 'three';
      import { MindARThree } from 'mindar-image-three';
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

      // *** แก้ไขที่ 1: รอให้ HTML โหลดเสร็จก่อน ***
      window.addEventListener('DOMContentLoaded', () => {

        // 3. เริ่มต้น MindAR
        const mindarThree = new MindARThree({
          container: document.querySelector("#container"), 
          imageTargetSrc: "AR_Marker/targets.mind",
          
          // *** แก้ไขที่ 2: นี่คือ "Sticky Mode" ที่ถูกต้องครับ! ***
          buffer: true 
        });
        const {renderer, scene, camera} = mindarThree;

        // 4. สร้าง Anchor (ใช้ 'addAnchor' ตามปกติ)
        // *** แก้ไขที่ 3: เปลี่ยน 'addBufferAnchor' (ที่ผิด) กลับเป็น 'addAnchor' (ที่ถูก) ***
        const anchor = mindarThree.addAnchor(0); 

        // 5. โหลดวิดีโอ (จาก HTML)
        const video = document.querySelector("#networkVideo"); 
        const videoTexture = new THREE.VideoTexture(video);
        const videoGeometry = new THREE.PlaneGeometry(1, 0.56);
        const videoMaterial = new THREE.MeshBasicMaterial({ map: videoTexture });
        const videoMesh = new THREE.Mesh(videoGeometry, videoMaterial);
        videoMesh.position.set(0, 0.5, 0); 
        anchor.group.add(videoMesh);

        // 6. โหลดโมเดล (GLB)
        const loader = new GLTFLoader();
        loader.load(
          "Job/Network/network-model.glb",
          (gltf) => {
            gltf.scene.scale.set(0.2, 0.2, 0.2); 
            gltf.scene.position.set(0, 0, 0);   
            anchor.group.add(gltf.scene); 
          }
        );

        // 7. ปุ่มควบคุม (Start/Stop)
        const start = async() => {
          await mindarThree.start();
          renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
          });
        }

        const startButton = document.querySelector("#startButton"); 
        const stopButton = document.querySelector("#stopButton");   

        startButton.addEventListener("click", () => {
          video.play(); 
          start();
        });
        stopButton.addEventListener("click", () => {
          mindarThree.stop();
          mindarThree.renderer.setAnimationLoop(null);
        });

      // *** ปิดวงเล็บของ DOMContentLoaded ***
      }); 
    </script>

    <style>
      body { margin: 0; }
      #container { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
      #control { position: fixed; top: 0; left: 0; z-index: 2; }
      #networkVideo { display: none; }
    </style>
  </head>
  <body>
    <div id="control">
      <button id="startButton">Start</button>
      <button id="stopButton">Stop</button>
    </div>
    <div id="container">
    </div>

    <video 
      id="networkVideo"
      src="Job/Network/video-network.mp4"
      muted
      loop
      playsinline>
    </video>
  </body>
</html>