<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Camera Permission Demo</title>
  <style>
    :root{--bg:#0b0b0b;--card:#0f1720;--accent:#10b981}
    body{margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--bg); color:#fff; font-family:system-ui,Segoe UI,Roboto,Arial}
    .card{width:min(820px,94vw); background:var(--card); padding:18px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    h1{margin:0 0 8px 0; font-size:1.05rem}
    p{margin:0 0 14px 0; color:rgba(255,255,255,0.8)}
    .controls{display:flex; gap:8px; align-items:center}
    button{padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600}
    button.primary{background:var(--accent); color:#042016}
    button.ghost{background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.06)}
    #status{margin-top:10px; color:rgba(255,255,255,0.85)}
    .videoWrap{margin-top:12px; background:#000; border-radius:10px; overflow:hidden; width:100%; aspect-ratio:16/9; display:flex; align-items:center; justify-content:center}
    video{width:100%; height:100%; object-fit:cover; display:block; transform:scaleX(-1)} /* mirror for selfie feel - remove transform if not wanted */
    .note{margin-top:10px; font-size:0.9rem; color:rgba(255,255,255,0.6)}
  </style>
</head>
<body>
  <div class="card">
    <h1>ทดลองเปิดกล้อง (Simple)</h1>
    <p>กดปุ่มด้านล่างเพื่อขออนุญาตกล้องและแสดงภาพกล้องบนหน้าเว็บ — ต้องรันบน HTTPS หรือ localhost</p>

    <div class="controls">
      <button id="startBtn" class="primary">Start Camera</button>
      <button id="stopBtn" class="ghost" disabled>Stop Camera</button>
      <div id="status" aria-live="polite">สถานะ: ยังไม่เริ่ม</div>
    </div>

    <div class="videoWrap" id="videoWrap" style="margin-top:14px;">
      <!-- video element จะถูกเชื่อม stream เมื่ออนุญาต -->
      <video id="cameraVideo" playsinline autoplay muted></video>
    </div>

    <div class="note">หมายเหตุ: ถ้ารันบนไฟล์ (`file://`) หรือ HTTP ที่ไม่ปลอดภัย กล้องจะไม่ทำงาน</div>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const videoEl = document.getElementById('cameraVideo');

    let currentStream = null;

    function setStatus(msg){
      statusEl.textContent = 'สถานะ: ' + msg;
    }

    async function startCamera(){
      setStatus('ขออนุญาตกล้อง...');
      startBtn.disabled = true;

      // พยายามใช้กล้องหลังเป็นค่าเริ่มต้น (สำหรับมือถือ)
      const constraintsExact = { video: { facingMode: { exact: 'environment' } }, audio: false };
      const constraintsFallback = { video: { facingMode: 'environment' }, audio: false };

      // ปิด stream เก่าถ้ามี
      stopCamera();

      try{
        // บางเบราว์เซอร์/อุปกรณ์ไม่รองรับ exact — ใช้ fallback
        try{
          currentStream = await navigator.mediaDevices.getUserMedia(constraintsExact);
        }catch(e){
          currentStream = await navigator.mediaDevices.getUserMedia(constraintsFallback);
        }

        // ผูก stream กับ video element
        videoEl.srcObject = currentStream;
        // บางเบราว์เซอร์ต้อง set muted = true เพื่อให้ autoplay ทำงาน (เราตั้ง muted โดย default)
        videoEl.muted = true;
        await videoEl.play().catch(()=>{/* ignore */});

        setStatus('กล้องเปิดแล้ว');
        stopBtn.disabled = false;
      }catch(err){
        console.error('getUserMedia error:', err);
        if(err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')){
          setStatus('ผู้ใช้ปฏิเสธอนุญาตกล้อง');
          alert('โปรดอนุญาตการเข้าถึงกล้องใน prompt ของเบราว์เซอร์');
        }else{
          setStatus('ไม่สามารถเปิดกล้อง: ' + (err.message || err.name));
          alert('ไม่สามารถเปิดกล้อง: ' + (err.message || err.name));
        }
        startBtn.disabled = false;
      }
    }

    function stopCamera(){
      if(currentStream){
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      try{ videoEl.pause(); }catch(e){}
      videoEl.srcObject = null;
      stopBtn.disabled = true;
      setStatus('หยุดกล้อง');
      startBtn.disabled = false;
    }

    startBtn.addEventListener('click', async () => {
      // เรียกจาก user gesture -> browser จะอนุญาต prompt
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('เบราว์เซอร์นี้ไม่รองรับกล้อง (getUserMedia) — ใช้ Chrome/Edge/Firefox รุ่นล่าสุด บน HTTPS หรือ localhost');
        return;
      }
      await startCamera();
    });

    stopBtn.addEventListener('click', () => {
      stopCamera();
    });

    // ป้องกันกรณีผู้ใช้เปลี่ยน permission ภายนอก: ถ้าไม่มี permission ให้ปุ่ม Start ทำงานต่อได้
    document.addEventListener('visibilitychange', () => {
      if(document.visibilityState === 'visible' && !currentStream){
        setStatus('พร้อม (กด Start เพื่อขออนุญาตกล้อง)');
      }
    });
  </script>
</body>
</html>
