<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Job Experience</title>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
          "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
        }
      }
    </script>

    <style>
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: #f9f9f9;
        overflow: hidden;
      }

      #container {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
      }

      /* ปุ่มเริ่ม AR */
      #startButton {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 14px 32px;
        background: black;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1em;
        cursor: pointer;
        z-index: 5;
        transition: 0.3s;
      }

      #startButton:hover {
        background: #333;
      }

      /* กรอบสแกน */
      #scan-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 200px;
        height: 200px;
        border: 2px solid #00ffcc;
        border-radius: 16px;
        transform: translate(-50%, -50%);
        opacity: 0.6;
        z-index: 3;
        display: none;
        animation: pulse 2s infinite ease-in-out;
      }

      @keyframes pulse {
        0% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.1);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;
        }
      }

      #networkVideo {
        display: none;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
    <div id="scan-frame"></div>
    <button id="startButton">Start AR</button>

    <video
      id="networkVideo"
      src="Job/Computer/Computer.mp4"
      muted
      loop
      playsinline
    ></video>

    <script type="module">
      import * as THREE from "three";
      import { MindARThree } from "mindar-image-three";
      import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

      window.addEventListener("DOMContentLoaded", () => {
        const container = document.querySelector("#container");
        const mindarThree = new MindARThree({
          container: container,
          imageTargetSrc: "AR_Marker/targets.mind",
        });

        const { renderer, scene, camera } = mindarThree;
        const anchor = mindarThree.addAnchor(0);

        const video = document.querySelector("#networkVideo");
        const videoTexture = new THREE.VideoTexture(video);
        const videoGeometry = new THREE.PlaneGeometry(1, 0.56);
        const videoMaterial = new THREE.MeshBasicMaterial({ map: videoTexture });
        const videoMesh = new THREE.Mesh(videoGeometry, videoMaterial);
        videoMesh.position.set(0, 0.5, 0);
        anchor.group.add(videoMesh);

        // โหลดโมเดล
        const loader = new GLTFLoader();
        loader.load("Job/Computer/Computer-Model.glb", (gltf) => {
          gltf.scene.scale.set(0.25, 0.25, 0.25);
          gltf.scene.position.set(0, 0, 0);
          anchor.group.add(gltf.scene);
        });

        // ---------- กันสั่น ----------
        const smoothedGroup = new THREE.Group();
        scene.add(smoothedGroup);
        smoothedGroup.add(anchor.group);
        let lastMatrix = new THREE.Matrix4();
        const lerpFactor = 0.15;

        anchor.onTargetFound = () => {
          document.querySelector("#scan-frame").style.display = "none";
          video.play();
        };
        anchor.onTargetLost = () => {
          video.pause();
        };

        const start = async () => {
          await mindarThree.start();
          renderer.setAnimationLoop(() => {
            if (anchor.group.visible) {
              const currentMatrix = anchor.group.matrixWorld.clone();
              if (lastMatrix) {
                smoothedGroup.matrixWorld
                  .copy(lastMatrix)
                  .lerp(currentMatrix, lerpFactor);
              } else {
                smoothedGroup.matrixWorld.copy(currentMatrix);
              }
              lastMatrix.copy(smoothedGroup.matrixWorld);

              smoothedGroup.position.setFromMatrixPosition(
                smoothedGroup.matrixWorld
              );
              smoothedGroup.quaternion.setFromRotationMatrix(
                smoothedGroup.matrixWorld
              );
              smoothedGroup.scale.setFromMatrixScale(smoothedGroup.matrixWorld);
              smoothedGroup.visible = true;
            } else {
              smoothedGroup.visible = false;
            }

            renderer.render(scene, camera);
          });
        };

        // ปุ่ม Start
        const startButton = document.querySelector("#startButton");
        startButton.addEventListener("click", async () => {
          try {
            // ขออนุญาตกล้อง
            await navigator.mediaDevices.getUserMedia({ video: true });
            document.querySelector("#scan-frame").style.display = "block";
            startButton.style.display = "none";
            await start();
          } catch (err) {
            alert("❗ กรุณาอนุญาตให้เข้าถึงกล้องเพื่อใช้งาน AR");
          }
        });
      });
    </script>
  </body>
</html>
